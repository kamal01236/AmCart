apiVersion: apps/v1
kind: Deployment
metadata:
	name: order-service
spec:
	replicas: 2
	selector:
		matchLabels:
			app: order-service
	template:
		metadata:
			labels:
				app: order-service
		spec:
			containers:
				- name: order-service
					image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
					imagePullPolicy: IfNotPresent
					ports:
						- containerPort: 8080
					env:
						- name: ASPNETCORE_ENVIRONMENT
							value: {{ .Values.environment | quote }}
						- name: ConnectionStrings__Orders
							valueFrom:
								secretKeyRef:
									name: order-service-db
									key: orders-connection
						- name: AzureAd__ClientId
							valueFrom:
								secretKeyRef:
									name: order-service-aad
									key: clientId
						- name: AzureAd__TenantId
							valueFrom:
								secretKeyRef:
									name: order-service-aad
									key: tenantId
						- name: AzureAd__Audience
							valueFrom:
								secretKeyRef:
									name: order-service-aad
									key: audience
						- name: Messaging__Kafka__BootstrapServers
							valueFrom:
								secretKeyRef:
									name: order-service-kafka
									key: bootstrapServers
						- name: Messaging__Kafka__OrderTopic
							valueFrom:
								secretKeyRef:
									name: order-service-kafka
									key: orderTopic
					readinessProbe:
						httpGet:
							path: /healthz
							port: 8080
						periodSeconds: 15
					livenessProbe:
						httpGet:
							path: /healthz
							port: 8080
						periodSeconds: 30
